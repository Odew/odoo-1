<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="assets_backend" name="website_sign assets" inherit_id="web.assets_backend">
        <xpath expr="." position="inside">
            <link rel="stylesheet" href="/website_sign/static/src/css/backend.css"/>
            <script type="text/javascript" src="/website_sign/static/src/js/backend.js"></script>
        </xpath>
    </template>

    <template id="assets_frontend" inherit_id="website.assets_frontend">
        <xpath expr="." position="inside">
            <link rel='stylesheet' href='/website_sign/static/src/css/frontend.css'/>

            <!-- <script type="text/javascript" src="/website/static/lib/jSignature/jSignature.min.js"></script> -->
            <script type="text/javascript" src="/website_sign/static/lib/jSignature/jSignature.min.js"></script>
            <script src="/website_sign/static/lib/pdfjs/build/pdf.js"/>
            <script src="/website_sign/static/lib/pdfjs/build/pdf.worker.js"/>

            <script type="text/javascript" src="/website_sign/static/src/js/sign.js"></script>
            <script type="text/javascript" src="/website_sign/static/src/js/pdf_view_edit.js"></script>
        </xpath>
    </template>

    <template id="website_sign.doc_sign" name="Document Sign">
        <t t-call="website.layout">
            <div class="container">
                <input id="document_viewmode" type="hidden" t-att-value="viewmode"/>
                <h2><strong><t t-esc="signature_request.attachment.name"/></strong> - Signature Request</h2>

                <div class="row">
                    <div class="col-md-3">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h4>
                                    <t t-if="signature_request.nb_closed == len(signature_request.request_items)">
                                        Signed (<t t-raw="str(signature_request.nb_closed) +'/'+ str(signature_request.nb_closed)"/>)
                                    </t>
                                    <t t-if="signature_request.nb_closed != len(signature_request.request_items)">
                                        Waiting Signatures (<t t-raw="str(len(signature_request.request_items)-signature_request.nb_closed) +'/'+ str(len(signature_request.request_items))"/>)
                                    </t>
                                </h4>
                            </div>
                            <div class="panel-body">
                                <t t-foreach="signature_request.request_items" t-as="sign">
                                    <div t-if="sign.state != 'closed'"><span style="color:red;"><b><t t-raw="sign.partner_id.name"/></b> has to sign.</span> <em t-if="sign.state != 'opened'">(the mail access has not been sent yet)</em></div>
                                    <div t-if="sign.state == 'closed'"><b><t t-raw="sign.partner_id.name"/></b> signed on <t t-raw="sign.signing_date"/>.</div>
                                </t>
                            </div>
                        </div>

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <t t-if="not readonly">
                                    <a t-if="not hasItems" class="btn btn-primary btn-block fa fa-check" data-toggle="modal" data-target="#signature_dialog">
                                        Sign Document
                                    </a>
                                    <t t-if="hasItems">
                                        <button id="signature-validate-button" class="btn btn-primary btn-block" type="button" disabled="disabled"/>
                                        <button id="start-completion-button" class="btn btn-primary btn-block" type="button">Start completion</button>
                                    </t>
                                </t>
                                <t t-if="current_request_item and current_request_item.state == 'closed'">
                                    <h4 class="modal-title">You have signed the document.</h4>
                                </t>
                                <t t-if="not current_request_item">
                                    <h4 class="modal-title">Need to sign? Check your mail box to get your secure access !</h4>
                                </t>
                                
                            </div>
                            <div class="panel-body">
                                <h4><t t-raw="signature_request.attachment.name"/></h4>
                                <p t-if="signature_request.attachment.description"><t t-raw="signature_request.attachment.description"/></p>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-9">
                        <div t-if="message==1" class="alert alert-success alert-dismissable">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&amp;times;</button>
                            Your message has been successfully sent!
                        </div>
                        <div t-if="message==2" class="alert alert-success alert-dismissable">
                            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&amp;times;</button>
                            You have successfully signed the document.
                        </div>

                        <div t-if="not hasItems">
                            <a t-att-href="'/website_sign/download/' + str(signature_request.id) + '/origin'" target="_blank">
                                <img t-if="signature_request.attachment.file_type_icon == 'webimage'" class="media-object" t-att-src="'/web/binary/image?model=ir.attachment&amp;field=datas&amp;id=' + str(signature_request.attachment.id) + '&amp;resize=300,180'" style="width: 400px;"/>
                                <img t-if="signature_request.attachment.file_type_icon != 'webimage'" class="media-object" t-att-src="'/mail/static/src/img/mimetypes/' + signature_request.attachment.file_type_icon + '.png'" style="width: 400px;"/>
                            </a>
                        </div>
                        <t t-if="hasItems">
                            <t t-call="website_sign.items_view"/>
                        </t>

                        <t t-foreach="signature_request.request_items" t-as="sign">
                            <div class="row" t-if="sign.state == 'closed'">
                                <img t-if="sign.signature" class="media-object pull-left" t-att-src="'/web/binary/image?model=signature.request.item&amp;field=signature&amp;id=' + str(sign.id) + '&amp;resize=500,180'" style="width: 150px;"/>
                                <div style="line-height:65px; font-weight:bold;">
                                    <t t-if="not sign.signature">Signed </t>by <t t-raw="sign.signer_name"/> on <t t-raw="sign.signing_date"/>.
                                </div>
                            </div>
                        </t>

                        <section class="mt32 mb32 css_editable_mode_hidden hidden-print">
                            <form id="comment" t-attf-action="/sign/document/{{signature_request.id}}/{{token}}/note" method="POST">
                                <h1 class="page-header hidden-print">History</h1>
                                <div class="pull left mb32 mt32" style="width: 75%">
                                    <t t-if="current_request_item">
                                        <textarea rows="4" name="comment" class="form-control" placeholder="Send us a note..."></textarea>
                                        <button type="submit" class="btn btn-primary mt8">Send</button>
                                    </t>
                                </div>
                                <t t-call="website_sign.chatter"/>
                            </form>
                        </section>
                        <div class="clearfix"/>

                        <form t-if="not hasItems" id="sign_doc" method="post" t-attf-action="/website_sign/signed/{{signature_request.id}}/{{token}}">
                            <t t-call="website_sign.signature_dialog">
                                <t t-set="signer_name" t-value="Name"/>
                                <t t-if="current_request_item">
                                    <t t-set="signer_name" t-value="current_request_item.partner_id.name"/>
                                </t>  
                            </t>
                        </form>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <template id="website_sign.signature_dialog">
        <div class="modal fade" id="signature_dialog" role="dialog" data-toggle="modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&amp;times;</button>
                        <h4 class="modal-title">Sign</h4>
                    </div>
                    <div class="modal-body">
                        <div id="signer_info" class="form-group">
                            <label class="control-label" for="name">Your Name</label>
                            <input class="form-control" name="signer" id="signer_name" t-att-value="signer_name" type="text"/>
                            <div class="panel panel-default mt16 mb0" id="signature_draw">
                                <div class="panel-heading">
                                    <a id="sign_select_style" class="pull-right btn btn-xs">Select style</a>
                                    <a id="sign_clean" class="pull-right btn btn-xs">Clear</a>
                                    <input type="file" name="files[]" id="sign_load" class="pull-right btn btn-xs" value="Load"/>
                                    <a id="auto_sign_mode" class="sign_mode btn">Auto</a>
                                    <a id="draw_sign_mode" class="sign_mode btn">Draw</a>
                                    <a id="load_sign_mode" class="sign_mode btn">Load</a>
                                </div>
                                <div id="sign" class="panel-body" style="padding: 0"/>
                                <p id="sign_instruction" class="panel-footer text-center"/>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="confirm_sign" data-dismiss="modal" class="btn btn-primary confirm_sign">Sign</button> or
                        <button type="button" class="btn btn-link" data-dismiss="modal" style="padding: 0">Cancel</button>
                    </div>

                    <div id="font_dialog" class="panel panel-default">
                        <div class="panel-heading">Styles</div>
                        <div id="sign_font_selection" class="panel-body"/>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="website_sign.chatter">
        <ul class="media-list hidden-print" id="comments-list">
            <t t-foreach="messages" t-as="message">
                <li class="media" t-if="message.type &lt;&gt; 'comment' or message.subtype_id">
                    <div class="media-body">
                        <img class="media-object pull-left" t-att-src="website.image_url(message.author_id, 'image_small')" style="width: 50px; margin-right: 10px;"/>
                        <div class="media-body">
                            <h5 class="media-heading">
                                <span t-field="message.author_id"/> <small>on <span t-field="message.date"/></small>
                            </h5>
                            <div t-field="message.body"/>
                        </div>
                    </div>
                </li>
            </t>
        </ul>
    </template>

    <template id="website_sign.deleted_sign_request">
        <t t-call="website.layout">
            <body>
                <div class="container">
                    <h3>Missing signature request</h3>
                    <p>
                        The signature access you are trying to reach does not exist. Maybe the signature request has been deleted or modified. <br/>
                        If there still exists a signature request for this document, it's <a t-att-href="url">here</a>. If it exists you can check if you are in the asked signers there and get your access in your mail box!
                    </p>
                </div>
            </body>
        </t>
    </template>
</odoo>
